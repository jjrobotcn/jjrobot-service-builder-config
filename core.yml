version: "3"

services:
  db:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/mongo:4.0.5
    container_name: db
    restart: always
    environment:
    - MONGO_INITDB_ROOT_USERNAME=robotjj
    - MONGO_INITDB_ROOT_PASSWORD=ROBOTjjROBOT
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /var/lib/jjrobot/jdb_mgo:/data/db
  redis:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/redis:5.0.3
    container_name: robot-redis
    restart: always
    volumes:
    - /etc/localtime:/etc/localtime:ro
  frpc:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/frpc:1.1.0
    container_name: frpc
    restart: always
    network_mode: host
    volumes:
    - /etc/localtime:/etc/localtime:ro
  auth:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/auth:1.1.4
    container_name: auth
    restart: always
    environment:
    - jwt_timeout_sec=604800
    - PASSWORD=123456
    - HTTP_URI_VALID_PREFIXES=/api/,/daemon/api/,/service/ws
    - HTTP_URI_VALID_IGNORED=/daemon/api/v1/info
    labels:
    - traefik.enable=true
    - traefik.port=9000
    - traefik.frontend.rule=Method:GET,POST,PATCH,PUT,DELETE;PathPrefix:/auth
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /var/lib/jjrobot/certs:/certs
  api-doc:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/api-doc:1.2.1
    container_name: api-doc
    restart: always
    labels:
      - traefik.enable=true
      - traefik.port=80
      - traefik.frontend.rule=PathPrefix:/api_doc
  cors:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/cors-preflight:1.0.0
    container_name: cors
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
    labels:
      - traefik.enable=true
      - traefik.port=80
      - traefik.frontend.rule=Method:OPTIONS
  gateway:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/gateway:2.7.0
    container_name: gateway
    restart: always
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - /var/lib/jjrobot/certs/fullchain.pem:/certs/cert.crt:ro
    - /var/lib/jjrobot/certs/privkey.pem:/certs/cert.key:ro
    - /etc/localtime:/etc/localtime:ro
    ports:
    - 80:80
    - 443:443
    - 81:81
    - 8001:8001
  daemon-reverse-proxy:
    container_name: daemon-reverse-proxy
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/daemon-reverse-proxy:1.0.0
    restart: always
    labels:
      - traefik.enable=true
      - traefik.port=80
      - traefik.frontend.rule=PathPrefix:/daemon
  management-pages:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/management-pages:2.8.1
    container_name: management-pages
    restart: always
    labels:
      - traefik.enable=true
      - traefik.port=80
      - traefik.frontend.rule=PathPrefix:/
  ws_gateway:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/ws_gateway:2.4.0
    container_name: ws_gateway
    restart: always
    labels:
      - traefik.enable=true
      - traefik.port=8000
      - traefik.v1.frontend.rule=PathPrefix:/service/ws;ReplacePath:/service/ws/v2
      - traefik.v2.frontend.rule=PathPrefix:/service/ws/v2
    volumes:
    - /etc/localtime:/etc/localtime:ro
  messaging:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/messaging:1.0.4
    container_name: messaging
    restart: always
    labels:
      - traefik.enable=true
      - traefik.grpc.protocol=h2c
      - traefik.grpc.port=8000
      - traefik.grpc.frontend.rule=PathPrefix:/messagingService.MessagingService
    volumes:
    - /etc/localtime:/etc/localtime:ro
  import-export:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/import_export:1.2.0
    container_name: import-export
    restart: always
    labels:
      - traefik.enable=true
      - traefik.port=8000
      - traefik.frontend.rule=PathPrefix:/api/v2/import_export
    volumes:
    - /etc/localtime:/etc/localtime:ro
  kms:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/kms:latest
    container_name: kms
    restart: always
    network_mode: host
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/lib/jjrobot/dvr:/dvr
    environment:
      - KMS_TURN_URL=test:abc@119.23.254.113:3478
  webrtc-server:
    image: registry.cn-shenzhen.aliyuncs.com/jjrobot/webrtc-server:1.1.1
    container_name: webrtc-server
    restart: always
    environment:
      - KMS_WS_URI=ws://10.10.10.2:8888/kurento
    labels:
      - traefik.enable=true
      - traefik.port=8000
      - traefik.frontend.rule=Method:GET;PathPrefix:/api/v2/camera/webrtc;ReplacePath:/webrtc

networks:
  default:
    external:
      name: robotnet
